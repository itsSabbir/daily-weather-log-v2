# .github/workflows/weather_fetcher.yml
# Production Grade: Enhanced Weather Data Fetcher
# This workflow fetches hourly weather data, applies personalized commit authorship,
# and incorporates comprehensive error handling, explicit logic steps, and best practices
# for maximum clarity, robustness, and maintainability in a production environment.

name: Fetch Hourly Weather Data

on:
  schedule:
    # Scheduled run: At 15 minutes past every hour (UTC).
    - cron: '15 * * * *'
  workflow_dispatch: # Allows manual triggering from the GitHub Actions UI.
  push: # Triggers on pushes to the main branch (useful for testing workflow modifications).
    branches:
      - main # Adjust if your default branch is different (e.g., master).

# Concurrency Management:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }} # Group by workflow name and branch reference.
  cancel-in-progress: true

jobs:
  fetch-and-commit-weather:
    name: Fetch, Process, and Commit Weather Data
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # Essential for committing changes back to the repository.

    env:
      TARGET_FILENAME: "weather_data.csv"        # The CSV file to store weather data.
      PYTHON_VERSION: '3.11'                     # Specify the Python version to use.
      GIT_AUTHOR_NAME: "Sabbir Hossain"
      GIT_AUTHOR_EMAIL: "hossain.sabbir17@gmail.com"

    steps:
      # --- Step 1: Source Code Checkout ---
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches complete Git history for operations like 'pull --rebase'.

      # --- Step 2: Python Environment Setup ---
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt' # Cache based on requirements.txt

      # --- Step 3: Install Python Script Dependencies ---
      - name: Install dependencies
        run: |
          echo "Upgrading pip package manager..."
          python -m pip install --upgrade pip
          echo "Installing Python dependencies from requirements.txt..."
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found. Please ensure it exists in your repository."
            exit 1
          fi
          echo "Python dependencies installation complete."

      # --- Step 4: Execute Weather Data Fetch Script ---
      - name: Fetch and write weather data
        id: fetch_data
        run: python fetch_weather.py # IMPORTANT: Ensure this is your correct script name (e.g., fetch_weather_aggregator.py)

      # --- Step 5: Verify File Changes Post-Script Execution ---
      - name: Check for file changes
        id: git_diff
        run: |
          echo "Verifying content changes in '${{ env.TARGET_FILENAME }}'..."
          if git diff --quiet --exit-code ${{ env.TARGET_FILENAME }}; then
            echo "No content modifications detected in '${{ env.TARGET_FILENAME }}'."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Content modifications detected in '${{ env.TARGET_FILENAME }}'."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true # 'git diff' exits 1 if changes are found, which is not an error here.

      # --- Step 6: Configure Git User for Commit Authorship ---
      - name: Configure Git User for commit
        if: steps.git_diff.outputs.changed == 'true'
        run: |
          echo "Configuring Git user for commit authorship as '${{ env.GIT_AUTHOR_NAME }}'..."
          git config --local user.name "${{ env.GIT_AUTHOR_NAME }}"
          git config --local user.email "${{ env.GIT_AUTHOR_EMAIL }}"
          echo "Git commit author set to: ${{ env.GIT_AUTHOR_NAME }} <${{ env.GIT_AUTHOR_EMAIL }}>"

      # --- Step 7: Stage, Commit, and Push Changes ---
      - name: Commit and push if changes exist
        if: steps.git_diff.outputs.changed == 'true'
        run: |
          echo "Preparing to stage, commit, and push changes for '${{ env.TARGET_FILENAME }}'..."
          
          echo "Staging changes for '${{ env.TARGET_FILENAME }}'..."
          git add ${{ env.TARGET_FILENAME }}

          echo "Verifying staged content to prevent empty commits..."
          if git diff --staged --quiet; then
            echo "WARNING: No actual content changes were staged after 'git add'."
            echo "Skipping commit to prevent an empty or unnecessary commit."
          else
            COMMIT_TIMESTAMP_UTC=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            COMMIT_MESSAGE="Automated weather data update: ${COMMIT_TIMESTAMP_UTC}"
            
            echo "Creating Git commit with message: '${COMMIT_MESSAGE}'"
            git commit --author="${{ env.GIT_AUTHOR_NAME }} <${{ env.GIT_AUTHOR_EMAIL }}>" -m "${COMMIT_MESSAGE}"
            echo "Commit created successfully by '${{ env.GIT_AUTHOR_NAME }} <${{ env.GIT_AUTHOR_EMAIL }}>'."

            REMOTE_BRANCH_NAME="${{ github.ref_name }}"
            echo "Attempting to synchronize local branch with remote '${REMOTE_BRANCH_NAME}' using 'git pull --rebase'..."
            if ! git pull --rebase origin ${REMOTE_BRANCH_NAME}; then
                echo "CRITICAL FAILURE: 'git pull --rebase origin ${REMOTE_BRANCH_NAME}' failed. Aborting push."
                exit 1
            fi
            echo "Synchronization with remote branch '${REMOTE_BRANCH_NAME}' successful."

            MAX_PUSH_ATTEMPTS=3
            PUSH_RETRY_DELAY_SECONDS=20
            for (( attempt=1; attempt<=MAX_PUSH_ATTEMPTS; attempt++ )); do
              echo "Attempting to push commit to 'origin/${REMOTE_BRANCH_NAME}' (Attempt ${attempt}/${MAX_PUSH_ATTEMPTS})..."
              if git push origin ${REMOTE_BRANCH_NAME}; then
                echo "Push successful on attempt #${attempt}!"
                break
              fi
              
              if [ ${attempt} -lt ${MAX_PUSH_ATTEMPTS} ]; then
                echo "Push attempt #${attempt} failed. Retrying in ${PUSH_RETRY_DELAY_SECONDS} seconds..."
                sleep ${PUSH_RETRY_DELAY_SECONDS}
              else
                echo "CRITICAL FAILURE: All ${MAX_PUSH_ATTEMPTS} push attempts to 'origin/${REMOTE_BRANCH_NAME}' failed. Manual intervention required."
                exit 1
              fi
            done
            echo "Commit and push process for '${{ env.TARGET_FILENAME }}' successfully completed."
          fi

      # --- Step 8: Report if No Action Was Taken ---
      - name: No changes to commit
        if: steps.git_diff.outputs.changed != 'true'
        run: |
          echo "No content changes were detected in '${{ env.TARGET_FILENAME }}' by the 'Check for file changes' step."
          echo "Therefore, no Git commit actions were performed for this run."